import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from arch import arch_model
import requests
from evaluate_strategy import evaluate_performance  # å‡è®¾è¿™æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„è¯„ä¼°æ¨¡å—

# è®¾ç½®éšæœºç§å­ä»¥ç¡®ä¿ç»“æœå¯é‡å¤
np.random.seed(42)

# FMP API é…ç½®
API_KEY = "qhylk6wN8OUWTgmLddldoMRPCo59NmBU"
BASE_URL = "https://financialmodelingprep.com/api/v3/historical-price-full/GOOG"


# ==================================================
# ğŸ“Œ 1. ä» FMP API è·å–æ•°æ®
# ==================================================
def fetch_stock_data(symbol, api_key, start_date=None, end_date=None):
    url = f"{BASE_URL}?apikey={api_key}"
    if start_date and end_date:
        url += f"&from={start_date}&to={end_date}"
    response = requests.get(url)
    if response.status_code != 200:
        raise ValueError(f"API è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç : {response.status_code}")
    data = response.json()
    if 'historical' not in data or not data['historical']:
        raise ValueError("æœªè·å–åˆ°å†å²æ•°æ®ï¼")

    # è½¬æ¢ä¸º DataFrame
    df = pd.DataFrame(data['historical'])
    df['date'] = pd.to_datetime(df['date'])
    df = df.rename(columns={'date': 'Date', 'close': 'Close'})
    df = df[['Date', 'Close']].set_index('Date').sort_index()
    return df


# è·å–æ•°æ®ï¼ˆä» 2024-01-01 åˆ° 2025-02-24ï¼‰
æ•°æ® = fetch_stock_data("GOOG", API_KEY, "2024-01-01", "2025-02-24")
æ•°æ® = æ•°æ®.ffill()  # ä½¿ç”¨å‰å‘å¡«å……å¤„ç†ç¼ºå¤±å€¼ï¼ˆç§»é™¤è­¦å‘Šï¼‰

# å®šä¹‰å…³é”®å‚æ•°
è®­ç»ƒå¤©æ•° = min(120, len(æ•°æ®) - 30)  # è®­ç»ƒæ•°æ®è‡³å°‘120å¤©
é¢„æµ‹å¤©æ•° = 30  # é¢„æµ‹æœªæ¥30å¤©
ç»“æŸæ—¥æœŸ = pd.Timestamp("2025-01-02")  # å›ºå®šçš„è®­ç»ƒç»“æŸæ—¥æœŸ

# æ£€æŸ¥æ•°æ®æ˜¯å¦è¶³å¤Ÿ
if len(æ•°æ®) < è®­ç»ƒå¤©æ•° + é¢„æµ‹å¤©æ•°:
    raise ValueError(f"æ•°æ®ä¸è¶³ï¼ç°æœ‰: {len(æ•°æ®)} å¤©ï¼Œéœ€: {è®­ç»ƒå¤©æ•° + é¢„æµ‹å¤©æ•°} å¤©")

# ==================================================
# ğŸ“Œ 2. å‡†å¤‡è®­ç»ƒæ•°æ®
# ==================================================
è®­ç»ƒå¼€å§‹æ—¥æœŸ = ç»“æŸæ—¥æœŸ - pd.DateOffset(days=è®­ç»ƒå¤©æ•°)
è®­ç»ƒæ•°æ® = æ•°æ®.loc[è®­ç»ƒå¼€å§‹æ—¥æœŸ:ç»“æŸæ—¥æœŸ, 'Close']

# è®¡ç®—æ—¥æ”¶ç›Šç‡
æ”¶ç›Šç‡ = è®­ç»ƒæ•°æ®.pct_change().dropna().values.flatten()
if len(æ”¶ç›Šç‡) == 0:
    raise ValueError("æ”¶ç›Šç‡æ•°æ®ä¸ºç©ºï¼Œæ— æ³•è®­ç»ƒ GARCH æ¨¡å‹ï¼")

# ==================================================
# ğŸ“Œ 3. è®­ç»ƒ GARCH(1,1) æ¨¡å‹
# ==================================================
# æ•°æ®ç¼©æ”¾ï¼šå°†æ”¶ç›Šç‡ä¹˜ä»¥100ä»¥ä¼˜åŒ– GARCH å‚æ•°ä¼°è®¡
ç¼©æ”¾å› å­ = 100
æ”¶ç›Šç‡_scaled = æ”¶ç›Šç‡ * ç¼©æ”¾å› å­
garchæ¨¡å‹ = arch_model(æ”¶ç›Šç‡_scaled, vol='Garch', p=1, q=1, dist='normal', rescale=False)  # è®¾ç½® rescale=False ä»¥é¿å…è‡ªåŠ¨ç¼©æ”¾
garchæ‹Ÿåˆ = garchæ¨¡å‹.fit(disp="off")  # å…³é—­è®­ç»ƒè¿‡ç¨‹çš„è¾“å‡º

# é¢„æµ‹æœªæ¥30å¤©çš„æ³¢åŠ¨ç‡ï¼Œå¹¶æ¢å¤åŸå§‹è§„æ¨¡
é¢„æµ‹ç»“æœ = garchæ‹Ÿåˆ.forecast(horizon=é¢„æµ‹å¤©æ•°)
æ³¢åŠ¨ç‡é¢„æµ‹ = np.sqrt(é¢„æµ‹ç»“æœ.variance.values[-1, :]) / ç¼©æ”¾å› å­  # é™¤ä»¥ç¼©æ”¾å› å­æ¢å¤åŸå§‹è§„æ¨¡

# ç¡®ä¿æ³¢åŠ¨ç‡é¢„æµ‹çš„é•¿åº¦è¶³å¤Ÿ
if len(æ³¢åŠ¨ç‡é¢„æµ‹) < é¢„æµ‹å¤©æ•°:
    æ³¢åŠ¨ç‡é¢„æµ‹ = np.full(é¢„æµ‹å¤©æ•°, np.mean(æ³¢åŠ¨ç‡é¢„æµ‹))

# ==================================================
# ğŸ“Œ 4. ä½¿ç”¨å‡ ä½•å¸ƒæœ—è¿åŠ¨ (GBM) æ¨¡æ‹Ÿæœªæ¥è‚¡ä»·
# ==================================================
å¹³å‡æ”¶ç›Šç‡ = æ”¶ç›Šç‡.mean()  # å†å²å¹³å‡æ”¶ç›Šç‡ï¼ˆæ— éœ€ç¼©æ”¾ï¼Œå› ä¸ºç”¨äº GBMï¼‰
åˆå§‹è‚¡ä»· = è®­ç»ƒæ•°æ®.iloc[-1]  # ä½¿ç”¨æœ€åä¸€å¤©çš„æ”¶ç›˜ä»·ä½œä¸ºåˆå§‹å€¼
æ¨¡æ‹Ÿè‚¡ä»· = [åˆå§‹è‚¡ä»·]

# æ¨¡æ‹Ÿæœªæ¥30å¤©çš„è‚¡ä»·
for t in range(é¢„æµ‹å¤©æ•°):
    æ³¢åŠ¨ç‡ = æ³¢åŠ¨ç‡é¢„æµ‹[t]  # å½“å¤©çš„æ³¢åŠ¨ç‡
    éšæœºæ‰°åŠ¨ = np.random.normal(0, 1)  # ç”Ÿæˆæ ‡å‡†æ­£æ€åˆ†å¸ƒçš„éšæœºæ•°
    æ–°è‚¡ä»· = æ¨¡æ‹Ÿè‚¡ä»·[-1] * np.exp((å¹³å‡æ”¶ç›Šç‡ - 0.5 * æ³¢åŠ¨ç‡ ** 2) + æ³¢åŠ¨ç‡ * éšæœºæ‰°åŠ¨)  # GBMå…¬å¼
    æ¨¡æ‹Ÿè‚¡ä»·.append(æ–°è‚¡ä»·)

é¢„æµ‹è‚¡ä»· = np.array(æ¨¡æ‹Ÿè‚¡ä»·[1:])  # å»æ‰åˆå§‹è‚¡ä»·ï¼Œä»…ä¿ç•™é¢„æµ‹ç»“æœ

# ==================================================
# ğŸ“Œ 5. è·å–çœŸå®è‚¡ä»·ç”¨äºå¯¹æ¯”
# ==================================================
æµ‹è¯•å¼€å§‹æ—¥æœŸ = ç»“æŸæ—¥æœŸ + pd.DateOffset(days=1)
æµ‹è¯•ç»“æŸæ—¥æœŸ = ç»“æŸæ—¥æœŸ + pd.DateOffset(days=é¢„æµ‹å¤©æ•°)
æµ‹è¯•æ•°æ® = æ•°æ®.loc[æµ‹è¯•å¼€å§‹æ—¥æœŸ:æµ‹è¯•ç»“æŸæ—¥æœŸ, 'Close']

# å¦‚æœæµ‹è¯•æ•°æ®ä¸è¶³30å¤©ï¼Œç”¨NaNå¡«å……
if len(æµ‹è¯•æ•°æ®) < é¢„æµ‹å¤©æ•°:
    æµ‹è¯•æ•°æ® = pd.Series(
        np.concatenate([æµ‹è¯•æ•°æ®.values, [np.nan] * (é¢„æµ‹å¤©æ•° - len(æµ‹è¯•æ•°æ®))]),
        index=pd.date_range(start=æµ‹è¯•å¼€å§‹æ—¥æœŸ, periods=é¢„æµ‹å¤©æ•°)
    )

# ==================================================
# ğŸ“Œ 6. ç»˜åˆ¶é¢„æµ‹è‚¡ä»·ä¸çœŸå®è‚¡ä»·å¯¹æ¯”å›¾
# ==================================================
plt.figure(figsize=(12, 6))
plt.plot(æµ‹è¯•æ•°æ®.index, æµ‹è¯•æ•°æ®.values, label='çœŸå®è‚¡ä»·', color='green', marker='o')
plt.plot(pd.date_range(start=æµ‹è¯•å¼€å§‹æ—¥æœŸ, periods=é¢„æµ‹å¤©æ•°), é¢„æµ‹è‚¡ä»·,
         label='é¢„æµ‹è‚¡ä»·', color='red', linestyle='dashed', marker='x')
plt.title("è‚¡ä»·é¢„æµ‹: GARCH + GBM")
plt.xlabel("æ—¥æœŸ")
plt.ylabel("è‚¡ä»·")
plt.xticks(rotation=45)
plt.legend()
plt.grid(True)
plt.show()